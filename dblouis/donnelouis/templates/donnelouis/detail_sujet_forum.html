{% extends 'donnelouis/base.html' %}
{% load forum_filters %}

{% block title %}{{ sujet.titre }} - Forum L'Air du Vol{% endblock %}

{% block content %}
<!-- En-tête du sujet -->
<div class="forum-subject-detail">
    <div class="forum-subject-header">
        <div class="forum-subject-title">
            <h1>{{ sujet.titre }}</h1>
            <div class="forum-subject-info">
                <span class="me-3">
                    <i class="fas fa-user"></i> 
                    <strong>{{ sujet.get_auteur_display }}</strong>
                </span>
                <span class="me-3">
                    <i class="fas fa-calendar"></i> 
                    {{ sujet.date_creation|date:"d M Y à H:i" }}
                </span>
                <span class="forum-category-badge">
                    <i class="fas fa-folder"></i> {{ sujet.categorie|title }}
                </span>
            </div>
        </div>
        <div class="forum-actions">
            {% if user == sujet.auteur or user.is_staff %}
                <a href="{% url 'editer_sujet_forum' sujet.slug %}" class="forum-action-btn edit">
                    <i class="fas fa-edit"></i> Éditer
                </a>
                <a href="{% url 'supprimer_sujet_forum' sujet.slug %}" class="forum-action-btn delete">
                    <i class="fas fa-trash"></i> Supprimer
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Tags -->
    {% if sujet.tags %}
        <div class="forum-tags mb-3">
            {% for tag in sujet.tags|split:"," %}
                <span class="forum-tag">
                    <i class="fas fa-tag"></i> {{ tag|striptags|title|truncatewords:2 }}
                </span>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Statistiques -->
    <div class="forum-topic-stats">
        <div class="forum-topic-stat">
            <i class="fas fa-eye"></i>
            <strong>{{ sujet.vues }}</strong>
            <span>vue{{ sujet.vues|pluralize }}</span>
        </div>
        <div class="forum-topic-stat">
            <i class="fas fa-reply"></i>
            <strong>{{ reponses|length }}</strong>
            <span>réponse{{ reponses|length|pluralize }}</span>
        </div>
    </div>
</div>

<!-- Contenu principal du sujet -->
<div class="forum-subject-content">
    {{ sujet.contenu|linebreaks }}
    {% if sujet.date_modification != sujet.date_creation %}
        <hr class="my-3" style="opacity: 0.3;">
        <small style="opacity: 0.7;">
            <i class="fas fa-pencil"></i> Modifié le {{ sujet.date_modification|date:"d/m/Y à H:i" }}
        </small>
    {% endif %}
</div>

<!-- Section des réponses -->
<div class="forum-responses-section">
    <h3>
        <i class="fas fa-comments"></i> Réponses ({{ reponses|length }})
    </h3>

    <!-- Liste des réponses -->
    {% if reponses %}
        <div class="forum-responses-list">
            {% for reponse in reponses %}
                <div class="forum-response-card">
                    <div class="forum-response-header">
                        <div>
                            <div class="forum-response-author">
                                <div>
                                    <div class="forum-response-author-name">
                                        {{ reponse.get_auteur_display }}
                                    </div>
                                    <div class="forum-response-date">
                                        {{ reponse.date_creation|date:"d M Y à H:i" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if user == reponse.auteur or user.is_staff %}
                            <div>
                                <a href="{% url 'supprimer_reponse_forum' sujet.slug reponse.id %}" 
                                   class="forum-action-btn delete" style="padding: 0.4rem 0.8rem;">
                                    <i class="fas fa-trash"></i> Supprimer
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <div class="forum-response-content">
                        {{ reponse.contenu|linebreaks }}
                    </div>

                    {% if reponse.date_modification != reponse.date_creation %}
                        <small style="opacity: 0.7;">
                            <i class="fas fa-pencil"></i> Modifiée le {{ reponse.date_modification|date:"d/m/Y à H:i" }}
                        </small>
                    {% endif %}

                    <!-- Votes sur la réponse -->
                    <div class="forum-response-votes">
                        <button class="vote-btn" title="Marquer comme utile">
                            <i class="fas fa-thumbs-up"></i> Utile
                        </button>
                        <span class="vote-count">{{ reponse.votes }}</span>
                        <button class="vote-btn" title="Marquer comme non utile">
                            <i class="fas fa-thumbs-down"></i> Non utile
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="forum-empty-message">
            <i class="fas fa-inbox"></i>
            <p><strong>Aucune réponse pour le moment.</strong></p>
            <p>Soyez le premier à répondre !</p>
        </div>
    {% endif %}
</div>

<!-- Formulaire de réponse -->
{% if user.is_authenticated %}
    <div class="forum-reply-form">
        <h4>
            <i class="fas fa-edit"></i> Ajouter une réponse
        </h4>
        <form method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_contenu">Votre réponse</label>
                {{ form.contenu }}
            </div>
            <button type="submit" class="btn-submit">
                <i class="fas fa-paper-plane"></i> Envoyer la réponse
            </button>
        </form>
    </div>
{% else %}
    <div class="forum-reply-form">
        <h4>
            <i class="fas fa-edit"></i> Ajouter une réponse
        </h4>
        <p style="color: var(--text-gray); margin-bottom: 1rem;"><i class="fas fa-info-circle" style="color: var(--primary);"></i> Vous n'êtes pas connecté (facultatif) :</p>
        <form method="POST">
            {% csrf_token %}
            
            <!-- Nom -->
            <div class="form-group">
                <label for="id_auteur_nom">
                    <i class="fas fa-user"></i> Votre nom
                </label>
                <input type="text" name="auteur_nom" id="id_auteur_nom" class="form-control" placeholder="Votre nom (facultatif)">
            </div>

            <!-- Email -->
            <div class="form-group">
                <label for="id_auteur_email">
                    <i class="fas fa-envelope"></i> Votre email
                </label>
                <input type="email" name="auteur_email" id="id_auteur_email" class="form-control" placeholder="Votre email (facultatif)">
            </div>

            <!-- Réponse -->
            <div class="form-group">
                <label for="id_contenu">Votre réponse</label>
                {{ form.contenu }}
            </div>
            <button type="submit" class="btn-submit">
                <i class="fas fa-paper-plane"></i> Envoyer la réponse
            </button>
        </form>
    </div>
{% endif %}

<!-- Lien retour -->
<div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--bg-light);">
    <a href="{% url 'forum' %}" class="btn-create-topic" style="background: var(--secondary);">
        <i class="fas fa-arrow-left"></i> Retour au forum
    </a>
</div>
{% endblock %}
