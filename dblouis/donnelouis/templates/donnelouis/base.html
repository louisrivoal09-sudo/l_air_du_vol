{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}L'Air du VolÂ®{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <link rel="stylesheet" href="{% static 'css/user-settings.css' %}">
  <link rel="stylesheet" href="{% static 'css/onboarding.css' %}">
  <link rel="stylesheet" href="{% static 'css/offline.css' %}">
  <link rel="stylesheet" href="{% static 'css/article-interactions.css' %}">
  <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
  <link rel="stylesheet" href="{% static 'css/dark-mode-complete.css' %}">
  <link rel="stylesheet" href="{% static 'css/dark-mode-auth.css' %}">
  <link rel="stylesheet" href="{% static 'css/dark-mode-forum.css' %}">>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
  {% block extra_css %}{% endblock %}
</head>
<body data-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
  <!-- Barre du haut -->
  <header class="topbar">
    <div class="logo-site">
      <button id="toggle-sidebar" class="sidebar-toggle">â˜°</button>
      <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo-img">
      <span class="site-name">L'Air du volÂ®</span>
    </div>
    
    <!-- Notifications en temps rÃ©el -->
    {% if user.is_authenticated %}
    <div class="topbar-notifications">
      <button id="notifications-bell" class="notifications-bell" title="Notifications">
        ğŸ”” <span id="notifications-count" class="notifications-count" style="display: none;">0</span>
      </button>
      <div id="notifications-panel" class="notifications-panel" style="display: none;">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button id="mark-all-read" class="mark-all-read">Marquer tout comme lu</button>
        </div>
        <div id="notifications-list" class="notifications-list">
          <p class="empty-message">Aucune notification</p>
        </div>
      </div>
    </div>
    {% endif %}
  </header>

  <!-- Menu latÃ©ral -->
  <nav class="sidebar">
    <ul class="menu">
      <li><a href="{% url 'index' %}">Accueil ğŸ </a></li>
      
      <li class="has-submenu">
        <a href="#">Exploration ğŸ“š </a>
        <ul class="sous-menu">
          <li><a href="{% url 'liste_articles' %}">Articles ğŸ“°</a></li>
          <li><a href="{% url 'liste_medias' %}">MÃ©dias ğŸ–¥ï¸</a></li>
          <li><a href="{% url 'liste_liens' %}">Liens ğŸ”—</a></li>
          <li><a href="{% url 'liste_catalogue' %}">Catalogue Avion âœˆï¸</a></li>
        </ul>
      </li>
      
      <li class="has-submenu">
        <a href="#">CommunautÃ© ğŸ‘¥</a>
        <ul class="sous-menu">
          <li><a href="{% url 'contact' %}">Nous contacter ğŸ“</a></li>
          <li><a href="{% url 'forum' %}">Forum ğŸ’¬</a></li>
          {% if user.is_authenticated %}
            <li style="border-top: 1px solid #ddd; margin-top: 0.5rem; padding-top: 0.5rem;">
              <a href="{% url 'user_profile' %}">ğŸ‘¤ Mon Profil</a>
            </li>
          {% endif %}
        </ul>
      </li>

      {% if user.is_authenticated %}
      <li class="has-submenu">
        <a href="#">â• Ajouter du contenu</a>
        <ul class="sous-menu">
          <li><a href="{% url 'ajouter_article' %}">â• Article</a></li>
          <li><a href="{% url 'ajouter_media' %}">â• MÃ©dia</a></li>
          <li><a href="{% url 'ajouter_lien' %}">â• Lien</a></li>
          <li><a href="{% url 'ajouter_avion' %}">â• Avion</a></li>
        </ul>
      </li>
      {% endif %}
      
      <li><a href="#footer-cgu">CGU âš ï¸</a></li>
    </ul>
    
    <!-- Authentification -->
    <div class="sidebar-auth">
      {% if user.is_authenticated %}
        <div class="auth-user">
          <p>ğŸ‘¤ {{ user.username }}</p>
          <a href="{% url 'logout' %}" class="btn-logout">Se dÃ©connecter</a>
        </div>
      {% else %}
        <a href="{% url 'login' %}" class="btn-auth btn-login">ğŸ” Se connecter</a>
        <a href="{% url 'signup' %}" class="btn-auth btn-signup">âœï¸ S'inscrire</a>
      {% endif %}
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="main-content">
    <!-- Bandeau d'avertissement pour utilisateurs non connectÃ©s -->
    {% if not user.is_authenticated %}
      <div class="premium-banner">
        <div class="premium-banner-content">
          <div class="premium-banner-text">
            <h3><i class="fas fa-star"></i> AccÃ¨s Premium - 100% Gratuit</h3>
            <p>
              CrÃ©ez un compte gratuitement pour :
              <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li><strong>Lire autant d'articles que vous le souhaitez</strong> (actuellement limitÃ© Ã  10 par jour)</li>
                <li><strong>ZÃ©ro publicitÃ©</strong> - navigation fluide et sans interruption</li>
                <li><strong>CrÃ©er vos propres articles et contenus</strong></li>
                <li><strong>Participer Ã  la communautÃ©</strong> - forum sans restriction</li>
              </ul>
            </p>
          </div>
          <div class="premium-banner-actions">
            <a href="{% url 'signup' %}" class="btn-premium-signup">
              <i class="fas fa-user-plus"></i> S'inscrire Gratuitement
            </a>
            <a href="{% url 'login' %}" class="btn-premium-login">
              <i class="fas fa-sign-in-alt"></i> Se Connecter
            </a>
          </div>
          {% if request.article_remaining is not None %}
            <div class="premium-banner-counter">
              <i class="fas fa-newspaper"></i>
              Articles restants aujourd'hui: <strong>{{ request.article_remaining }}/10</strong>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

  <!-- CSRF Token for AJAX requests -->
  {% csrf_token %}
  <footer class="footer" id="footer-cgu">
    <div class="footer-content">
      <h3>Conditions GÃ©nÃ©rales d'Utilisation</h3>
      <p>En accÃ©dant au site <strong>L'Air du vol</strong>, vous acceptez nos conditions gÃ©nÃ©rales d'utilisation. Toute reproduction ou diffusion du contenu est interdite sans autorisation.</p>
      <p><strong>&copy; 2025 - L'Air du vol. Tous droits rÃ©servÃ©s.</strong></p>
    <p> &copy Site crÃ©Ã© par Louis Rivoal.</p>    </div>
  </footer>

  <!-- Bouton Assistant IA -->
  <button id="ai-chat-btn" title="Ouvrir l'assistant IA">ğŸ’¬</button>

  <!-- Modale Chat IA -->
  <div id="ai-chat-modal">
    <div class="ai-chat-header">
      <div>
        <h3>Assistant IA L'Air du Vol</h3>
        <div class="ai-chat-header-subtitle">âš¡ RÃ©ponses instantanÃ©es</div>
      </div>
      <button id="restart-tutorial-btn" class="restart-tutorial-btn" title="RedÃ©marrer le tutoriel">ğŸ“</button>
      <button id="close-ai-chat" title="Fermer le chat">&times;</button>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages">
      <div class="ai-message ai system">
        Bienvenue! ğŸ‘‹ Je suis l'assistant IA de L'Air du Vol. Comment puis-je vous aider?
      </div>

  <!-- Script JavaScript pour les notifications -->
  <script>
    // Configuration des notifications en temps rÃ©el
    const notificationManager = {
      bell: document.getElementById('notifications-bell'),
      panel: document.getElementById('notifications-panel'),
      list: document.getElementById('notifications-list'),
      count: document.getElementById('notifications-count'),
      markAllBtn: document.getElementById('mark-all-read'),
      
      init() {
        if (!this.bell) return; // Pas de notifications pour utilisateurs non connectÃ©s
        
        this.bell.addEventListener('click', () => this.togglePanel());
        this.markAllBtn.addEventListener('click', () => this.markAllAsRead());
        
        // RÃ©cupÃ©rer les notifications toutes les 30 secondes
        this.fetchNotifications();
        setInterval(() => this.fetchNotifications(), 30000);
        
        // Fermer le panneau si on clique ailleurs
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.topbar-notifications')) {
            this.panel.style.display = 'none';
          }
        });
      },
      
      togglePanel() {
        if (this.panel.style.display === 'none' || !this.panel.style.display) {
          this.panel.style.display = 'block';
        } else {
          this.panel.style.display = 'none';
        }
      },
      
      async fetchNotifications() {
        try {
          const response = await fetch('/api/notifications/');
          const data = await response.json();
          
          if (data.success) {
            this.updatePanel(data.notifications);
            this.updateBadge(data.count);
          }
        } catch (error) {
          console.error('Erreur rÃ©cupÃ©ration notifications:', error);
        }
      },
      
      updatePanel(notifications) {
        if (notifications.length === 0) {
          this.list.innerHTML = '<p class="empty-message">Aucune notification</p>';
          return;
        }
        
        this.list.innerHTML = notifications.map(notif => `
          <div class="notification-item unread" data-type="${notif.type}" data-id="${notif.id}">
            <div class="notification-content">
              <span class="notification-icon">${this.getIcon(notif.type)}</span>
              <div class="notification-text">
                <div class="notification-badge">${notif.type.replace('_', ' ')}</div>
                <div class="notification-title">${notif.titre}</div>
                <div class="notification-message">${notif.message}</div>
                <div class="notification-time">${notif.date}</div>
              </div>
            </div>
          </div>
        `).join('');
        
        // Ajouter les event listeners pour les notifications
        this.list.querySelectorAll('.notification-item').forEach(item => {
          item.addEventListener('click', () => {
            const notifId = item.dataset.id;
            const type = item.dataset.type;
            
            // Marquer comme lue
            this.markAsRead(notifId);
            
            // Rediriger si URL disponible
            if (item.querySelector('a')) {
              window.location.href = item.querySelector('a').href;
            }
          });
        });
      },
      
      updateBadge(count) {
        if (count > 0) {
          this.count.textContent = count;
          this.count.style.display = 'flex';
          this.bell.classList.add('has-unread');
        } else {
          this.count.style.display = 'none';
          this.bell.classList.remove('has-unread');
        }
      },
      
      async markAsRead(notifId) {
        try {
          await fetch(`/api/notifications/${notifId}/lue/`, { method: 'POST' });
          this.fetchNotifications();
        } catch (error) {
          console.error('Erreur marquage notification:', error);
        }
      },
      
      async markAllAsRead() {
        try {
          await fetch('/api/notifications/marquer-toutes-lues/', { method: 'POST' });
          this.fetchNotifications();
        } catch (error) {
          console.error('Erreur marquage notifications:', error);
        }
      },
      
      getIcon(type) {
        const icons = {
          'forum_reponse': 'ğŸ’¬',
          'forum_mention': '@ï¸',
          'article_nouveau': 'ğŸ“°',
          'media_nouveau': 'ğŸ¥',
          'catalogue_nouveau': 'âœˆï¸',
          'commentaire_reponse': 'ğŸ’­',
          'auth_required': 'ğŸ”',
        };
        return icons[type] || 'ğŸ””';
      }
    };
    
    // Initialiser quand le DOM est prÃªt
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => notificationManager.init());
    } else {
      notificationManager.init();
    }
  </script>
    </div>
    <div class="typing-indicator" id="typing-indicator">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>
    <div class="ai-chat-input">
      <textarea id="ai-input" placeholder="Posez votre question..." rows="1"></textarea>
      <button id="ai-send-btn" title="Envoyer (Ctrl+EntrÃ©e)"></button>
    </div>
  </div>

  <script src="{% static 'js/user-settings.js' %}"></script>
  <script src="{% static 'js/onboarding.js' %}"></script>
  <script src="{% static 'js/offline.js' %}"></script>
  <script src="{% static 'js/article-interactions.js' %}"></script>
  <script src="{% static 'js/main.js' %}"></script>
  <script src="{% static 'js/ai-chat.js' %}"></script>
  {% block extra_js %}{% endblock %}
</body>
</html>