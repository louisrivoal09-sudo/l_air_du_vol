{% extends 'donnelouis/base.html' %}
{% load static %}

{% block title %}{{ article.titre }} - L'Air du Vol¬Æ{% endblock %}

{% block content %}
<!-- Barre de progression -->
<div class="reading-progress">
  <div class="reading-progress-bar" id="reading-progress-bar"></div>
</div>

<!-- Article complet -->
<div class="card" style="max-width: 1200px; margin: 0 auto;" data-article-id="{{ article.id }}">
  <div class="card-content" style="padding: 3rem;">
    <h1 class="preview-title">{{ article.titre }}</h1>
    <p class="preview-date">Publi√© le {{ article.date_publication|date:"d F Y" }}</p>
    
    <!-- Boutons d'action -->
    <div class="article-actions">
      <button class="download-article-btn" onclick="downloadArticleAsPDF()">
        üìÑ T√©l√©charger en PDF
      </button>
      <button class="share-article-btn" onclick="shareArticle()">
        üì§ Partager
      </button>
    </div>
    
    <!-- R√©sum√© -->
    {% if article.resume %}
    <div class="preview-resume">
      {{ article.resume }}
    </div>
    {% endif %}
    
    <!-- Th√®me 1 -->
    {% if article.theme1_titre %}
    <h2 class="preview-theme">{{ article.theme1_titre }}</h2>
    
    {% if article.theme1_section_a_titre %}
    <h3 class="preview-section-title">{{ article.theme1_section_a_titre }}</h3>
    <p class="preview-text">{{ article.theme1_section_a_texte|linebreaks }}</p>
    {% endif %}
    
    {% if article.theme1_section_b_titre %}
    <h3 class="preview-section-title">{{ article.theme1_section_b_titre }}</h3>
    <p class="preview-text">{{ article.theme1_section_b_texte|linebreaks }}</p>
    {% endif %}
    {% endif %}
    
    <!-- Th√®me 2 -->
    {% if article.theme2_titre %}
    <h2 class="preview-theme">{{ article.theme2_titre }}</h2>
    
    {% if article.theme2_section_a_titre %}
    <h3 class="preview-section-title">{{ article.theme2_section_a_titre }}</h3>
    <p class="preview-text">{{ article.theme2_section_a_texte|linebreaks }}</p>
    {% endif %}
    
    {% if article.theme2_section_b_titre %}
    <h3 class="preview-section-title">{{ article.theme2_section_b_titre }}</h3>
    <p class="preview-text">{{ article.theme2_section_b_texte|linebreaks }}</p>
    {% endif %}
    {% endif %}
    
    <!-- Th√®me 3 -->
    {% if article.theme3_titre %}
    <h2 class="preview-theme">{{ article.theme3_titre }}</h2>
    
    {% if article.theme3_section_a_titre %}
    <h3 class="preview-section-title">{{ article.theme3_section_a_titre }}</h3>
    <p class="preview-text">{{ article.theme3_section_a_texte|linebreaks }}</p>
    {% endif %}
    
    {% if article.theme3_section_b_titre %}
    <h3 class="preview-section-title">{{ article.theme3_section_b_titre }}</h3>
    <p class="preview-text">{{ article.theme3_section_b_texte|linebreaks }}</p>
    {% endif %}
    {% endif %}
    
    <!-- Conclusion -->
    {% if article.conclusion_texte %}
    <h2 class="preview-conclusion-title">{{ article.conclusion_titre }}</h2>
    <p class="preview-conclusion-text">{{ article.conclusion_texte|linebreaks }}</p>
    {% endif %}
    
    <!-- Galerie d'images -->
    {% if article.images.all %}
    <div class="article-gallery">
      <h3>üì∏ Galerie photos</h3>
      <div class="gallery-grid">
        {% for image in article.images.all %}
        <div class="gallery-item" data-caption="{{ image.legende }}">
          <img src="{{ image.image_url }}" alt="{{ image.legende }}">
          <div class="gallery-caption">{{ image.legende }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    <!-- SECTION COMMENTAIRES -->
    <div class="comments-section" style="margin-top: 4rem; padding-top: 3rem; border-top: 2px solid #E5E7EB;">
      <h2 style="margin-bottom: 2rem;">üí≠ Commentaires</h2>
      
      <!-- Formulaire d'ajout de commentaire -->
      <div class="add-comment-form" style="background: var(--bg-light); padding: 2rem; border-radius: var(--radius-xl); margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">Ajouter un commentaire</h3>
        
        <form id="comment-form" style="display: flex; flex-direction: column; gap: 1rem;">
          {% csrf_token %}
          
          {% if not user.is_authenticated %}
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <input type="text" id="comment-auteur" placeholder="Votre nom (optionnel)" style="padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: var(--radius); font-size: 0.95rem;">
            <input type="email" id="comment-email" placeholder="Votre email (optionnel)" style="padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: var(--radius); font-size: 0.95rem;">
          </div>
          {% endif %}
          
          <textarea 
            id="comment-content" 
            placeholder="Votre commentaire..." 
            rows="4" 
            required
            style="padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: var(--radius); font-size: 0.95rem; font-family: inherit;">
          </textarea>
          
          <div style="display: flex; gap: 1rem; align-items: center;">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%); flex-grow: 1;">
              ‚úì Publier le commentaire
            </button>
            <button type="button" class="btn" style="background: #EF4444;" onclick="toggleReportForm()" title="Signaler ce contenu">
              üö© Signaler
            </button>
          </div>
        </form>
      </div>
      
      <!-- Formulaire de signalement (cach√© par d√©faut) -->
      <div id="report-form" style="background: #FEE2E2; padding: 2rem; border-radius: var(--radius-xl); margin-bottom: 2rem; display: none; border: 2px solid #FCA5A5;">
        <h3 style="margin-bottom: 1rem; color: #991B1B;">üö© Signaler cet article</h3>
        <form id="article-report-form" style="display: flex; flex-direction: column; gap: 1rem;">
          {% csrf_token %}
          
          <select id="report-reason" required style="padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: var(--radius);">
            <option value="">-- S√©lectionner une raison --</option>
            <option value="spam">Spam</option>
            <option value="offensant">Contenu offensant</option>
            <option value="inexact">Information inexacte</option>
            <option value="publicite">Publicit√© non autoris√©e</option>
            <option value="autre">Autre</option>
          </select>
          
          <textarea 
            id="report-description" 
            placeholder="D√©tails du signalement (optionnel)" 
            rows="3"
            style="padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: var(--radius); font-size: 0.95rem; font-family: inherit;">
          </textarea>
          
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); flex-grow: 1;">
              Envoyer le signalement
            </button>
            <button type="button" class="btn" style="background: #9CA3AF;" onclick="toggleReportForm()">
              Annuler
            </button>
          </div>
        </form>
      </div>
      
      <!-- Liste des commentaires -->
      <div id="comments-list" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <p style="text-align: center; color: var(--text-gray);">Chargement des commentaires...</p>
      </div>
    </div>
    
    <a href="{% url 'liste_articles' %}" class="btn" style="margin-top: 3rem; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
      ‚Üê Retour aux articles
    </a>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <div class="lightbox-toolbar">
    <button class="lightbox-btn lightbox-download" id="lightbox-download" title="T√©l√©charger">üì•</button>
    <button class="lightbox-btn lightbox-close" id="lightbox-close" title="Fermer">√ó</button>
  </div>
  <button class="lightbox-nav lightbox-prev" id="lightbox-prev">‚ùÆ</button>
  <div class="lightbox-content">
    <img id="lightbox-img" src="" alt="">
  </div>
  <button class="lightbox-nav lightbox-next" id="lightbox-next">‚ùØ</button>
  <div class="lightbox-caption">
    <div id="lightbox-caption-text"></div>
    <div class="lightbox-counter" id="lightbox-counter"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Barre de progression
window.addEventListener('scroll', () => {
  const progressBar = document.getElementById('reading-progress-bar');
  const article = document.querySelector('.card-content');
  const windowHeight = window.innerHeight;
  const docHeight = article.offsetHeight;
  const scrollTop = window.pageYOffset;
  const progress = (scrollTop / (docHeight - windowHeight)) * 100;
  progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
});

// T√©l√©chargement PDF
function downloadArticleAsPDF() {
  const content = document.querySelector('.card-content').cloneNode(true);
  content.querySelectorAll('.article-actions, .btn').forEach(el => el.remove());
  
  const printWindow = window.open('', '', 'width=900,height=700');
  printWindow.document.write(`
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8"/>
        <title>{{ article.titre }}</title>
        <style>
          body { font-family: Arial; padding: 30px; }
          h1 { color: #0A2463; font-size: 28px; }
          h2 { color: #0A2463; font-size: 22px; margin-top: 20px; }
          h3 { color: #4B5563; font-size: 18px; }
          p { line-height: 1.6; text-align: justify; }
        </style>
      </head>
      <body>
        <div style="text-align:center; margin-bottom: 30px;">
          <h1>L'Air du Vol¬Æ</h1>
        </div>
        ${content.innerHTML}
        <div style="margin-top:50px; padding-top:20px; border-top:2px solid #ddd; text-align:center; color:#666;">
          <p>Document g√©n√©r√© par L'Air du Vol - ${new Date().toLocaleDateString('fr-FR')}</p>
        </div>
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.onload = function() { printWindow.print(); };
}

// Partage
function shareArticle() {
  const title = "{{ article.titre }}";
  const url = window.location.href;
  const text = `D√©couvrez l'article "${title}" sur L'Air du Vol`;
  
  if (navigator.share) {
    navigator.share({ title, text, url }).catch(() => {});
  } else {
    navigator.clipboard.writeText(url).then(() => {
      alert('üîó Lien copi√© dans le presse-papiers !');
    });
  }
}

// Lightbox
const galleryItems = document.querySelectorAll('.gallery-item');
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxClose = document.getElementById('lightbox-close');
const lightboxPrev = document.getElementById('lightbox-prev');
const lightboxNext = document.getElementById('lightbox-next');
const lightboxCounter = document.getElementById('lightbox-counter');
const lightboxCaptionText = document.getElementById('lightbox-caption-text');
const lightboxDownload = document.getElementById('lightbox-download');

let currentIndex = 0;
const images = Array.from(galleryItems).map(item => ({
  src: item.querySelector('img').src,
  caption: item.dataset.caption || ''
}));

function showImage(index) {
  currentIndex = index;
  const image = images[index];
  lightboxImg.src = image.src;
  lightboxCaptionText.textContent = image.caption;
  lightboxCounter.textContent = `${index + 1} / ${images.length}`;
  lightboxPrev.disabled = index === 0;
  lightboxNext.disabled = index === images.length - 1;
  lightbox.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeLightbox() {
  lightbox.classList.remove('show');
  document.body.style.overflow = '';
}

galleryItems.forEach((item, index) => {
  item.addEventListener('click', () => showImage(index));
});

lightboxPrev.addEventListener('click', () => {
  if (currentIndex > 0) showImage(currentIndex - 1);
});

lightboxNext.addEventListener('click', () => {
  if (currentIndex < images.length - 1) showImage(currentIndex + 1);
});

lightboxClose.addEventListener('click', closeLightbox);
lightbox.addEventListener('click', (e) => {
  if (e.target === lightbox) closeLightbox();
});

lightboxDownload.addEventListener('click', () => {
  const link = document.createElement('a');
  link.href = lightboxImg.src;
  link.download = `image-${currentIndex + 1}.jpg`;
  link.click();
});

document.addEventListener('keydown', (e) => {
  if (!lightbox.classList.contains('show')) return;
  if (e.key === 'Escape') closeLightbox();
  if (e.key === 'ArrowLeft' && currentIndex > 0) showImage(currentIndex - 1);
  if (e.key === 'ArrowRight' && currentIndex < images.length - 1) showImage(currentIndex + 1);
});

// ===== COMMENTAIRES ET SIGNALEMENTS =====

function toggleReportForm() {
  const reportForm = document.getElementById('report-form');
  reportForm.style.display = reportForm.style.display === 'none' ? 'block' : 'none';
  document.getElementById('comment-content').value = '';
}

// Charger les commentaires au chargement de la page
async function loadComments() {
  const articleId = document.querySelector('[data-article-id]').dataset.articleId;
  try {
    const response = await fetch(`/api/article/${articleId}/comments/`);
    const data = await response.json();
    
    if (data.success && data.comments.length > 0) {
      const commentsList = document.getElementById('comments-list');
      commentsList.innerHTML = data.comments.map(comment => `
        <div style="background: var(--bg-light); padding: 1.5rem; border-radius: var(--radius-lg); border-left: 4px solid var(--primary);">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <strong style="font-size: 1.05rem;">${comment.auteur}</strong>
            <span style="font-size: 0.85rem; color: var(--text-gray);">${comment.date}</span>
          </div>
          <p style="color: var(--text-dark); line-height: 1.6;">${comment.contenu}</p>
        </div>
      `).join('');
    } else {
      document.getElementById('comments-list').innerHTML = '<p style="text-align: center; color: var(--text-gray);">Aucun commentaire pour le moment. Soyez le premier √† commenter!</p>';
    }
  } catch (error) {
    console.error('Erreur chargement commentaires:', error);
    document.getElementById('comments-list').innerHTML = '<p style="color: #EF4444;">Erreur lors du chargement des commentaires</p>';
  }
}

// Ajouter un commentaire
document.getElementById('comment-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const articleId = document.querySelector('[data-article-id]').dataset.articleId;
  const content = document.getElementById('comment-content').value;
  const auteurNom = document.getElementById('comment-auteur')?.value || 'Anonyme';
  const auteurEmail = document.getElementById('comment-email')?.value || '';
  
  try {
    const response = await fetch(`/api/article/${articleId}/comment/add/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        contenu: content,
        auteur_nom: auteurNom,
        auteur_email: auteurEmail
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('comment-form').reset();
      loadComments();
      alert('‚úì ' + data.message);
    } else {
      alert('‚úó Erreur: ' + data.error);
    }
  } catch (error) {
    console.error('Erreur ajout commentaire:', error);
    alert('‚úó Erreur lors de l\'ajout du commentaire');
  }
});

// Signaler un article
document.getElementById('article-report-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const articleId = document.querySelector('[data-article-id]').dataset.articleId;
  const reason = document.getElementById('report-reason').value;
  const description = document.getElementById('report-description').value;
  
  try {
    const response = await fetch(`/api/article/${articleId}/report/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        raison: reason,
        description: description
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      toggleReportForm();
      alert('‚úì ' + data.message);
    } else {
      alert('‚úó Erreur: ' + data.error);
    }
  } catch (error) {
    console.error('Erreur signalement:', error);
    alert('‚úó Erreur lors du signalement');
  }
});

// Charger les commentaires au chargement
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadComments);
} else {
  loadComments();
}
</script>
{% endblock %}